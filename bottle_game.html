<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Poti Game</title>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
    }

    /* IMPORTANT: DO NOT FORCE CANVAS SIZE */
    canvas {
      display: block;
    }
  </style>
</head>

<body>

<script>
class GameScene extends Phaser.Scene {
  constructor() {
    super('GameScene');
    this.totalBottles = 6;
    this.gameActive = false;
  }

  preload() {
    this.load.image('background', 'licensed-image.jpg');
  }

  create() {
    /* =====================
       WORLD & CAMERA SETUP
       ===================== */
    this.worldWidth = 1600;   // bigger than screen
    this.worldHeight = 700;

    this.physics.world.setBounds(0, 0, this.worldWidth, this.worldHeight);
    this.cameras.main.setBounds(0, 0, this.worldWidth, this.worldHeight);

    /* =====================
       BACKGROUND
       ===================== */
    const bg = this.add.image(
      this.worldWidth / 2,
      this.worldHeight / 2,
      'background'
    );
    bg.setDisplaySize(this.worldWidth, this.worldHeight);
    bg.setScrollFactor(0);

    /* =====================
       TEXTURES
       ===================== */
    this.makeBetterPlayer();
    this.makeBottleTextures();
    this.makeTrashCanTexture();
    this.makePlatformTextures();

    /* =====================
       PLATFORMS & GROUND
       ===================== */
    this.platforms = this.physics.add.staticGroup();

    const groundY = this.worldHeight - 90;
    const ground = this.add.rectangle(
      this.worldWidth / 2,
      groundY,
      this.worldWidth,
      20,
      0x000000,
      0
    );
    this.physics.add.existing(ground, true);
    this.platforms.add(ground);

    const levelLayout = [
      { x: 220, y: 440, w: 150, c: 'plat_red' },
      { x: 450, y: 360, w: 150, c: 'plat_blue' },
      { x: 680, y: 400, w: 130, c: 'plat_yellow' },
      { x: 580, y: 230, w: 150, c: 'plat_green' },
      { x: 880, y: 300, w: 150, c: 'plat_red' },
      { x: 1200, y: 340, w: 150, c: 'plat_blue' }
    ];

    levelLayout.forEach(p => {
      const plat = this.platforms.create(p.x, p.y, p.c);
      plat.setDisplaySize(p.w, 35);
      plat.refreshBody();
    });

    /* =====================
       PLAYER
       ===================== */
    this.player = this.physics.add.sprite(100, groundY - 80, 'player_idle');
    this.player.setDisplaySize(50, 90);
    this.player.setCollideWorldBounds(true);
    this.player.setBounce(0.1);

    /* CAMERA FOLLOW */
    this.cameras.main.startFollow(this.player, true, 0.08, 0.08);

    /* =====================
       TRASH CAN
       ===================== */
    this.trashCan = this.physics.add.staticSprite(
      this.worldWidth - 80,
      groundY - 40,
      'trashcan'
    );
    this.trashCan.setDisplaySize(60, 80);

    /* =====================
       BOTTLES
       ===================== */
    this.bottles = this.physics.add.group({ allowGravity: false });

    levelLayout.forEach(p => {
      this.bottles.create(p.x, p.y - 60, 'glass');
    });

    /* =====================
       COLLISIONS
       ===================== */
    this.physics.add.collider(this.player, this.platforms);
    this.physics.add.overlap(
      this.player,
      this.bottles,
      this.collectBottle,
      null,
      this
    );

    /* =====================
       INPUT
       ===================== */
    this.cursors = this.input.keyboard.createCursorKeys();
    this.jumpKey = this.input.keyboard.addKey(
      Phaser.Input.Keyboard.KeyCodes.SPACE
    );

    /* =====================
       UI
       ===================== */
    this.collected = 0;
    this.deposited = 0;

    this.scoreText = this.add.text(
      20,
      20,
      'ჩანთაში: 0 | შეგროვებული: 0',
      {
        fontSize: '22px',
        fill: '#fff',
        stroke: '#000',
        strokeThickness: 4
      }
    );
    this.scoreText.setScrollFactor(0);

    /* START POPUP */
    this.showPopup(
      'LEVEL 1',
      'შეაგროვე 6 ბოთლი\nდა მოათავსე ნაგვის ურნაში',
      'დაწყება',
      () => (this.gameActive = true)
    );
  }

  update(time, delta) {
    if (!this.gameActive) {
      this.player.setVelocityX(0);
      return;
    }

    const onGround =
      this.player.body.blocked.down || this.player.body.touching.down;

    let vx = 0;
    if (this.cursors.left.isDown) vx = -300;
    if (this.cursors.right.isDown) vx = 300;
    this.player.setVelocityX(vx);

    if (
      (this.cursors.up.isDown || this.jumpKey.isDown) &&
      onGround
    ) {
      this.player.setVelocityY(-720);
    }
  }

  collectBottle(player, bottle) {
    bottle.disableBody(true, true);
    this.collected++;
    this.updateScore();
  }

  updateScore() {
    this.scoreText.setText(
      `ჩანთაში: ${this.collected} | შეგროვებული: ${this.deposited}`
    );
  }

  /* =====================
     POPUP
     ===================== */
  showPopup(title, desc, btn, cb) {
    const cx = this.cameras.main.midPoint.x;
    const cy = this.cameras.main.midPoint.y;

    const overlay = this.add
      .rectangle(cx, cy, 800, 600, 0x000000, 0.7)
      .setScrollFactor(0)
      .setDepth(100);

    const box = this.add
      .rectangle(cx, cy, 400, 260, 0xffffff)
      .setDepth(101)
      .setScrollFactor(0);

    const t = this.add
      .text(cx, cy - 80, title, {
        fontSize: '32px',
        fill: '#1b5e20'
      })
      .setOrigin(0.5)
      .setDepth(102)
      .setScrollFactor(0);

    const d = this.add
      .text(cx, cy - 10, desc, {
        fontSize: '18px',
        fill: '#333',
        align: 'center'
      })
      .setOrigin(0.5)
      .setDepth(102)
      .setScrollFactor(0);

    const b = this.add
      .rectangle(cx, cy + 80, 180, 50, 0x43a047)
      .setInteractive()
      .setDepth(102)
      .setScrollFactor(0);

    const bt = this.add
      .text(cx, cy + 80, btn, {
        fontSize: '20px',
        fill: '#fff'
      })
      .setOrigin(0.5)
      .setDepth(103)
      .setScrollFactor(0);

    b.on('pointerdown', () => {
      overlay.destroy();
      box.destroy();
      t.destroy();
      d.destroy();
      b.destroy();
      bt.destroy();
      cb();
    });
  }

  /* =====================
     TEXTURE HELPERS
     ===================== */
  makeBetterPlayer() {
    this.createPlayerPose('player_idle');
  }

  createPlayerPose(key) {
    const g = this.make.graphics({ add: false });
    g.fillStyle(0x1976d2);
    g.fillRoundedRect(0, 20, 50, 60, 8);
    g.fillStyle(0xffccbc);
    g.fillCircle(25, 12, 12);
    g.generateTexture(key, 50, 90);
    g.destroy();
  }

  makePlatformTextures() {
    const colors = {
      plat_red: 0xff4747,
      plat_blue: 0x47a3ff,
      plat_green: 0x47ff78,
      plat_yellow: 0xffd947
    };
    Object.entries(colors).forEach(([k, c]) => {
      const g = this.make.graphics({ add: false });
      g.fillStyle(c);
      g.fillRoundedRect(0, 0, 100, 30, 8);
      g.generateTexture(k, 100, 30);
      g.destroy();
    });
  }

  makeBottleTextures() {
    const g = this.make.graphics({ add: false });
    g.fillStyle(0xb3e5fc, 0.9);
    g.fillRoundedRect(4, 10, 22, 40, 6);
    g.generateTexture('glass', 30, 50);
    g.destroy();
  }

  makeTrashCanTexture() {
    const g = this.make.graphics({ add: false });
    g.fillStyle(0x424242);
    g.fillRoundedRect(0, 0, 60, 80, 6);
    g.generateTexture('trashcan', 60, 80);
    g.destroy();
  }
}

/* =====================
   GAME CONFIG
   ===================== */
const config = {
  type: Phaser.AUTO,
  width: 1200,
  height: 700,
  resolution: window.devicePixelRatio || 1,
  physics: {
    default: 'arcade',
    arcade: {
      gravity: { y: 1300 },
      debug: false
    }
  },
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: GameScene
};

new Phaser.Game(config);
</script>

</body>
</html>
