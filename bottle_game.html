<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Poti Game - Custom Background</title>
  <style>
    body { margin: 0; padding: 0; background-color: #000; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
    
    /* UI Layer */
    #ui-layer {
      position: fixed; top: 0; left: 0; width: 100%; padding: 20px; pointer-events: none; z-index: 10;
      display: flex; justify-content: space-between;
    }
    .hud-text {
      color: white; font-weight: bold; font-size: 20px; text-shadow: 2px 2px 0 #000;
      background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 8px;
    }

    /* Controls */
    .controls {
      position: fixed; bottom: 30px; width: 100%; height: 90px; z-index: 20;
      display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; pointer-events: none;
    }
    .btn-group { display: flex; gap: 20px; pointer-events: auto; }
    .control-btn {
      width: 80px; height: 80px; background: rgba(255, 255, 255, 0.25);
      border: 3px solid rgba(255, 255, 255, 0.6); border-radius: 50%;
      color: white; font-size: 32px; display: flex; align-items: center; justify-content: center;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .control-btn:active { background: rgba(0, 255, 0, 0.5); transform: scale(0.95); }
    .jump-btn { background: rgba(255, 165, 0, 0.4); }

    /* Game Area */
    #game-container { width: 100%; height: 100%; display: block; }

    /* Victory Popup */
    #popup-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
      display: flex; justify-content: center; align-items: center; z-index: 100;
      visibility: hidden; opacity: 0; transition: opacity 0.3s;
    }
    #popup-box {
      background: white; padding: 25px; border-radius: 12px; text-align: center; width: 300px;
      border-top: 6px solid #43a047;
    }
    .popup-btn {
      background: #43a047; color: white; border: none; padding: 10px 20px; font-size: 18px;
      border-radius: 6px; margin-top: 15px; cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body>

  <div id="ui-layer">
    <div class="hud-text">LEVEL 1</div>
    <div class="hud-text" id="score-display">Bag: 0 | Total: 0</div>
  </div>

  <div class="controls">
    <div class="btn-group">
      <div id="btn-left" class="control-btn">←</div>
      <div id="btn-right" class="control-btn">→</div>
    </div>
    <div class="btn-group">
      <div id="btn-jump" class="control-btn jump-btn">↑</div>
    </div>
  </div>

  <div id="popup-overlay">
    <div id="popup-box">
      <h2 style="margin-top:0;">You Win!</h2>
      <p>Nature is clean again.</p>
      <button class="popup-btn" onclick="location.reload()">Replay</button>
    </div>
  </div>

  <div id="game-container"></div>

<script>
class GameScene extends Phaser.Scene {
  constructor() {
    super('GameScene');
    this.inputs = { left: false, right: false, jump: false };
    this.collected = 0;
    this.deposited = 0;
    this.totalBottles = 6;
    this.walkTimer = 0;
  }

  preload() {
    // --- LOAD YOUR BACKGROUND HERE ---
    // Make sure the file is named 'background.png' and is in the same folder
    this.load.image('custom_bg', 'background.png'); 

    // Generate other graphics
    this.createPlayerPoses();
    this.createPlatformTextures();
    this.createItemTextures();
  }

  create() {
    // 1. Setup World Size (1600x1200)
    const worldW = 1600;
    const worldH = 1200; 
    this.physics.world.setBounds(0, 0, worldW, worldH);
    
    // --- ADD BACKGROUND IMAGE ---
    // We add this FIRST so it is behind everything else
    // We stretch it (setDisplaySize) to fill the whole world
    const bg = this.add.image(0, 0, 'custom_bg').setOrigin(0, 0);
    bg.setDisplaySize(worldW, worldH);

    // 2. Platforms
    this.platforms = this.physics.add.staticGroup();
    
    // Invisible Ground Line
    // I made this transparent (alpha = 0) so you see the background's ground,
    // but the player still walks on this physics line.
    const groundY = worldH - 60; // Adjust this number if your character is floating too high/low
    const ground = this.add.rectangle(worldW/2, groundY, worldW, 60, 0x000000); 
    ground.setAlpha(0); // Make invisible so we see the background image
    this.physics.add.existing(ground, true);
    this.platforms.add(ground);

    // 3. Floating Platforms
    const levels = [
      {x: 300, y: groundY - 150, t: 'plat_red'},
      {x: 600, y: groundY - 250, t: 'plat_blue'},
      {x: 900, y: groundY - 350, t: 'plat_yellow'},
      {x: 500, y: groundY - 450, t: 'plat_green'},
      {x: 1200, y: groundY - 300, t: 'plat_blue'},
      {x: 1450, y: groundY - 500, t: 'plat_yellow'},
      {x: 200, y: groundY - 450, t: 'plat_red'}
    ];

    levels.forEach(p => {
      const plat = this.platforms.create(p.x, p.y, p.t);
      plat.refreshBody();
    });

    // 4. Trash Can
    this.trashCan = this.physics.add.staticSprite(worldW - 150, groundY - 80, 'trashcan');
    this.trashCan.setDepth(5);

    // 5. Player
    this.player = this.physics.add.sprite(100, groundY - 200, 'player_idle');
    this.player.setCollideWorldBounds(true);
    this.player.setBounce(0.1);
    this.player.setDepth(10);
    this.player.body.setSize(40, 90);

    // 6. Camera (Zoomed to 0.65)
    this.cameras.main.setBounds(0, 0, worldW, worldH);
    this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
    this.cameras.main.setZoom(0.65);

    // 7. Bottles
    this.bottles = this.physics.add.group();
    levels.forEach(p => {
        const b = this.bottles.create(p.x, p.y - 60, 'bottle');
        this.tweens.add({ targets: b, y: b.y - 10, duration: 1500, yoyo: true, repeat: -1 });
    });

    // 8. Collisions
    this.physics.add.collider(this.player, this.platforms);
    this.physics.add.collider(this.bottles, this.platforms);
    this.physics.add.overlap(this.player, this.bottles, this.collectBottle, null, this);
    
    // 9. Controls
    this.cursors = this.input.keyboard.createCursorKeys();
    this.setupTouchControls();
  }

  update(time, delta) {
    const dist = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.trashCan.x, this.trashCan.y);
    if (dist < 100 && this.collected > 0) {
        this.depositBottles();
    }

    const speed = 400;
    const jumpForce = -950;
    const left = this.cursors.left.isDown || this.inputs.left;
    const right = this.cursors.right.isDown || this.inputs.right;
    const jump = this.cursors.up.isDown || this.inputs.jump;
    const onGround = this.player.body.touching.down;

    if (left) {
        this.player.setVelocityX(-speed);
        this.player.setFlipX(true);
        this.animateWalk(delta);
    } else if (right) {
        this.player.setVelocityX(speed);
        this.player.setFlipX(false);
        this.animateWalk(delta);
    } else {
        this.player.setVelocityX(0);
        this.player.setTexture('player_idle');
        this.walkTimer = 0;
    }

    if (jump && onGround) {
        this.player.setVelocityY(jumpForce);
    }
  }

  animateWalk(delta) {
    if (!this.player.body.touching.down) {
        this.player.setTexture('player_walk2'); 
        return;
    }
    this.walkTimer += delta;
    if (this.walkTimer > 150) {
        const cur = this.player.texture.key;
        this.player.setTexture(cur === 'player_walk1' ? 'player_walk2' : 'player_walk1');
        this.walkTimer = 0;
    }
  }

  collectBottle(player, bottle) {
    bottle.destroy();
    this.collected++;
    this.updateUI();
  }

  depositBottles() {
    this.deposited += this.collected;
    this.collected = 0;
    this.updateUI();
    this.trashCan.setTint(0x00ff00);
    this.time.delayedCall(200, () => this.trashCan.clearTint());
    
    if (this.deposited >= this.totalBottles) {
        this.time.delayedCall(500, () => {
            const ol = document.getElementById('popup-overlay');
            ol.style.visibility = 'visible'; ol.style.opacity = '1';
        });
    }
  }

  updateUI() {
    document.getElementById('score-display').innerText = `Bag: ${this.collected} | Total: ${this.deposited}`;
  }

  setupTouchControls() {
    const bind = (id, key) => {
        const btn = document.getElementById(id);
        const on = (e) => { e.preventDefault(); this.inputs[key] = true; };
        const off = (e) => { e.preventDefault(); this.inputs[key] = false; };
        btn.addEventListener('mousedown', on); btn.addEventListener('mouseup', off);
        btn.addEventListener('touchstart', on); btn.addEventListener('touchend', off);
    };
    bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');
  }

  // --- CHARACTER & ITEM GENERATORS ---
  createPlayerPoses() {
    const draw = (key, legL, legR, armL, armR) => {
        const g = this.make.graphics({add:false});
        g.fillStyle(0x1565c0); g.fillRect(15, 60+legL, 10, 25); g.fillRect(35, 60+legR, 10, 25);
        g.fillStyle(0x2196f3); g.fillRoundedRect(10, 30, 40, 35, 5);
        g.fillStyle(0x2196f3); g.fillRoundedRect(2, 30+armR, 10, 20, 3); g.fillRoundedRect(48, 30+legL, 10, 20, 3);
        g.fillStyle(0xffccbc); g.fillCircle(7, 53+armR, 5); g.fillCircle(53, 53+legL, 5);
        g.fillStyle(0xffccbc); g.fillCircle(30, 15, 14);
        g.fillStyle(0x3e2723); g.fillCircle(30, 10, 15);
        g.fillStyle(0x000000); g.fillCircle(25, 15, 2); g.fillCircle(35, 15, 2); 
        g.beginPath(); g.lineStyle(2,0x000000); g.arc(30,20,5,0,Math.PI); g.strokePath(); 
        g.generateTexture(key, 60, 90); g.destroy();
    };
    draw('player_idle', 0,0,0,0);
    draw('player_walk1', -5, 5, 5, -5);
    draw('player_walk2', 5, -5, -5, 5);
  }

  createPlatformTextures() {
    const colors = { plat_red: 0xe53935, plat_blue: 0x1e88e5, plat_yellow: 0xfdd835, plat_green: 0x43a047 };
    for (const [key, val] of Object.entries(colors)) {
        const g = this.make.graphics({add:false});
        g.fillStyle(val); g.fillRoundedRect(0,0,140,30,8);
        g.lineStyle(2,0xffffff); g.strokeRoundedRect(0,0,140,30,8);
        g.generateTexture(key, 140, 30); g.destroy();
    }
  }

  createItemTextures() {
    let g = this.make.graphics({add:false});
    g.fillStyle(0x81d4fa, 0.8); g.fillRoundedRect(10,10,20,30,5);
    g.fillStyle(0x4e342e); g.fillRect(15,2,10,8);
    g.generateTexture('bottle', 40, 45); g.destroy();
    g = this.make.graphics({add:false});
    g.fillStyle(0x424242); g.fillRoundedRect(5,20,60,70,5);
    g.fillStyle(0x66bb6a); g.fillTriangle(35,40,20,65,50,65);
    g.generateTexture('trashcan', 70, 95); g.destroy();
  }
}

const config = {
  type: Phaser.AUTO,
  scale: { mode: Phaser.Scale.RESIZE, parent: 'game-container', width: '100%', height: '100%' },
  physics: { default: 'arcade', arcade: { gravity: { y: 1600 }, debug: false } },
  scene: GameScene,
  backgroundColor: '#000'
};

new Phaser.Game(config);
</script>
</body>
</html>
