<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poti Game - HD Forest Version</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; touch-action: none; font-family: Arial, sans-serif; }
        
        /* Game Container */
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI Layer (Score) */
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            pointer-events: none; /* Let clicks pass through */
        }
        .score-text {
            color: white; font-size: 20px; font-weight: bold;
            text-shadow: 2px 2px 2px #000;
            background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 8px;
        }

        /* Controls Layer */
        #controls {
            position: absolute; bottom: 30px; left: 0; width: 100%; height: 100px;
            z-index: 20; display: flex; justify-content: space-between; padding: 0 40px;
            box-sizing: border-box; pointer-events: none;
        }
        
        /* Buttons */
        .btn-group { display: flex; gap: 20px; pointer-events: auto; }
        .control-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white; border-radius: 50%;
            color: white; font-size: 30px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none;
        }
        .control-btn:active { background: rgba(0, 255, 0, 0.5); transform: scale(0.95); }
        .jump-btn { background: rgba(255, 100, 0, 0.3); }

        /* Popup */
        #popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 10px; text-align: center;
            z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.7); display: none;
        }
        #popup button {
            background: #2e7d32; color: white; border: none; padding: 10px 20px;
            font-size: 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="score-text" id="score-text">ჩანთაში: 0 | სულ: 0</div>
    </div>

    <div id="controls">
        <div class="btn-group">
            <div id="btn-left" class="control-btn">←</div>
            <div id="btn-right" class="control-btn">→</div>
        </div>
        <div class="btn-group">
            <div id="btn-jump" class="control-btn jump-btn">↑</div>
        </div>
    </div>

    <div id="popup">
        <h2 id="popup-title">Level Complete!</h2>
        <p id="popup-msg">Good job.</p>
        <button onclick="restartLevel()">Play Again</button>
    </div>

    <div id="game-container"></div>

    <script>
        // Global Restart Function for the HTML button
        function restartLevel() {
            const game = Phaser.Game.instances[0]; // Get the game instance
            const scene = game.scene.getScene('MainScene');
            if(scene) scene.scene.restart();
            document.getElementById('popup').style.display = 'none';
        }

        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
                this.collected = 0;
                this.deposited = 0;
                this.goal = 6;
                this.isGameActive = true;
                this.walkTimer = 0;
            }

            preload() {
                // 1. High Res Background (Loading from a reliable placeholder source)
                this.load.image('bg', 'https://images.unsplash.com/photo-1448375240586-dfd8d3cd871d?q=80&w=2000&auto=format&fit=crop'); 
                
                // 2. Generate Character Textures (Idle, Walk1, Walk2)
                this.createCharacterTexture('player_idle', 0);
                this.createCharacterTexture('player_walk1', -1); // Left leg forward
                this.createCharacterTexture('player_walk2', 1);  // Right leg forward

                // 3. Generate Other Textures
                this.createGraphicsTextures();
            }

            create() {
                this.isGameActive = true;
                this.collected = 0;
                this.deposited = 0;
                this.updateScoreUI();

                // World Size (Larger than screen for scrolling)
                const worldW = 2000;
                const worldH = 900;
                this.physics.world.setBounds(0, 0, worldW, worldH);

                // --- Background ---
                // Add the high-res image and scale it to fit height, let width scroll
                const bg = this.add.image(0, 0, 'bg').setOrigin(0, 0);
                bg.displayHeight = worldH;
                bg.scaleX = bg.scaleY; // Maintain aspect ratio
                bg.setScrollFactor(0.5); // Parallax effect (moves slower than camera)
                
                // --- Platforms ---
                this.platforms = this.physics.add.staticGroup();
                
                // Ground (Invisible floor to match the picture, slightly raised)
                const ground = this.add.rectangle(worldW/2, worldH - 20, worldW, 60, 0x2e7d32); 
                this.physics.add.existing(ground, true);
                this.platforms.add(ground);

                // Floating Platforms
                const platLocs = [
                    {x: 300, y: 700}, {x: 600, y: 600}, {x: 900, y: 500}, 
                    {x: 1200, y: 650}, {x: 1500, y: 550}, {x: 500, y: 400}
                ];
                
                platLocs.forEach(pos => {
                    const p = this.platforms.create(pos.x, pos.y, 'platform');
                    p.setDisplaySize(160, 30);
                    p.refreshBody();
                });

                // --- Trash Can ---
                this.trashCan = this.physics.add.staticSprite(worldW - 150, worldH - 110, 'trashcan');
                this.trashCan.setDisplaySize(80, 100);

                // --- Player ---
                this.player = this.physics.add.sprite(100, worldH - 200, 'player_idle');
                this.player.setCollideWorldBounds(true);
                this.player.setBounce(0.1);
                this.player.setDisplaySize(60, 100); // Character Size
                this.player.body.setSize(40, 90);    // Hitbox

                // --- Camera ---
                this.cameras.main.setBounds(0, 0, worldW, worldH);
                this.cameras.main.startFollow(this.player, true, 0.05, 0.05);
                this.cameras.main.setZoom(1.0);

                // --- Bottles ---
                this.bottles = this.physics.add.group();
                platLocs.forEach(pos => {
                    const b = this.bottles.create(pos.x, pos.y - 60, 'bottle');
                    // Floating animation
                    this.tweens.add({
                        targets: b, y: b.y - 10, duration: 1500, yoyo: true, repeat: -1
                    });
                });

                // --- Physics & Inputs ---
                this.physics.add.collider(this.player, this.platforms);
                this.physics.add.collider(this.bottles, this.platforms);
                this.physics.add.overlap(this.player, this.bottles, this.collectBottle, null, this);
                
                this.cursors = this.input.keyboard.createCursorKeys();
                this.setupMobileControls();
            }

            update(time, delta) {
                if(!this.isGameActive) return;

                // Trash Can Logic
                const distToTrash = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.trashCan.x, this.trashCan.y);
                if (distToTrash < 100 && this.collected > 0) {
                    this.depositBottles();
                }

                // Movement Logic
                const speed = 360;
                const jumpForce = -900;
                const left = this.cursors.left.isDown || this.leftInput;
                const right = this.cursors.right.isDown || this.rightInput;
                const jump = this.cursors.up.isDown || this.jumpInput;

                if (left) {
                    this.player.setVelocityX(-speed);
                    this.player.setFlipX(true); // Face left
                    this.animatePlayer(delta);
                } else if (right) {
                    this.player.setVelocityX(speed);
                    this.player.setFlipX(false); // Face right
                    this.animatePlayer(delta);
                } else {
                    this.player.setVelocityX(0);
                    this.player.setTexture('player_idle');
                }

                if (jump && this.player.body.touching.down) {
                    this.player.setVelocityY(jumpForce);
                }
            }

            animatePlayer(delta) {
                // Simple animation: switch textures every 150ms
                if (!this.player.body.touching.down) {
                    this.player.setTexture('player_walk2'); // Jump pose
                    return;
                }
                
                this.walkTimer += delta;
                if (this.walkTimer > 150) {
                    const current = this.player.texture.key;
                    this.player.setTexture(current === 'player_walk1' ? 'player_walk2' : 'player_walk1');
                    this.walkTimer = 0;
                }
            }

            collectBottle(player, bottle) {
                bottle.destroy();
                this.collected++;
                this.updateScoreUI();
            }

            depositBottles() {
                this.deposited += this.collected;
                this.collected = 0;
                this.updateScoreUI();
                
                // Visual feedback
                this.trashCan.setTint(0x00ff00);
                this.time.delayedCall(200, () => this.trashCan.clearTint());

                if (this.deposited >= this.goal) {
                    this.winGame();
                }
            }

            updateScoreUI() {
                document.getElementById('score-text').innerText = `ჩანთაში: ${this.collected} | სულ: ${this.deposited}`;
            }

            winGame() {
                this.isGameActive = false;
                this.player.setVelocity(0, 0);
                document.getElementById('popup').style.display = 'block';
                document.getElementById('popup-title').innerText = "გილოცავ!";
                document.getElementById('popup-msg').innerText = "შენ გაასუფთავე გარემო!";
            }

            setupMobileControls() {
                this.leftInput = false; this.rightInput = false; this.jumpInput = false;

                const addTouch = (id, varName) => {
                    const btn = document.getElementById(id);
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); this[varName] = true; });
                    btn.addEventListener('touchend', (e) => { e.preventDefault(); this[varName] = false; });
                    btn.addEventListener('mousedown', (e) => { e.preventDefault(); this[varName] = true; });
                    btn.addEventListener('mouseup', (e) => { e.preventDefault(); this[varName] = false; });
                };

                addTouch('btn-left', 'leftInput');
                addTouch('btn-right', 'rightInput');
                addTouch('btn-jump', 'jumpInput');
            }

            // --- GRAPHICS GENERATORS (Draws the character and items in code) ---
            
            createCharacterTexture(name, stepDir) {
                // 0 = idle, -1 = left leg fwd, 1 = right leg fwd
                const g = this.make.graphics({ add: false });
                
                // Colors
                const skin = 0xffccbc;
                const shirt = 0x1976d2; // Blue
                const pants = 0x0d47a1; // Dark Blue
                const hair = 0x3e2723;

                // Legs (Adjust based on stepDir)
                let lOffset = stepDir * 5; 
                let rOffset = stepDir * -5;
                
                g.fillStyle(pants);
                g.fillRect(15, 60 + lOffset, 10, 25); // Left Leg
                g.fillRect(35, 60 + rOffset, 10, 25); // Right Leg

                // Body
                g.fillStyle(shirt);
                g.fillRect(10, 30, 40, 35); 

                // Arms & Hands (This fixes the "No Hands" issue)
                g.fillStyle(shirt);
                g.fillRect(5, 30 + rOffset, 8, 20); // Left Arm Sleeve
                g.fillRect(47, 30 + lOffset, 8, 20); // Right Arm Sleeve
                
                g.fillStyle(skin);
                g.fillCircle(9, 53 + rOffset, 5); // Left Hand
                g.fillCircle(51, 53 + lOffset, 5); // Right Hand

                // Head
                g.fillStyle(skin);
                g.fillCircle(30, 15, 15);
                
                // Hair
                g.fillStyle(hair);
                g.fillCircle(30, 10, 16);

                // Face
                g.fillStyle(0x000000);
                g.fillCircle(25, 15, 2); // Eye L
                g.fillCircle(35, 15, 2); // Eye R
                g.beginPath(); g.lineStyle(2, 0x000000); g.arc(30, 18, 5, 0, 3.14); g.strokePath(); // Smile

                g.generateTexture(name, 60, 100);
                g.destroy();
            }

            createGraphicsTextures() {
                // Platform
                let g = this.make.graphics({add: false});
                g.fillStyle(0x8d6e63); g.fillRoundedRect(0, 0, 160, 30, 10);
                g.lineStyle(2, 0x5d4037); g.strokeRoundedRect(0, 0, 160, 30, 10);
                g.generateTexture('platform', 160, 30); g.destroy();

                // Bottle
                g = this.make.graphics({add: false});
                g.fillStyle(0x4fc3f7, 0.7); g.fillRect(10, 10, 20, 30); // Body
                g.fillRect(15, 0, 10, 10); // Neck
                g.fillStyle(0xffffff, 0.5); g.fillRect(12, 12, 5, 25); // Shine
                g.generateTexture('bottle', 40, 40); g.destroy();

                // Trash Can
                g = this.make.graphics({add: false});
                g.fillStyle(0x616161); g.fillRect(10, 20, 60, 80);
                g.fillStyle(0x2e7d32); g.fillTriangle(40, 40, 30, 60, 50, 60); // Recycle Logo
                g.generateTexture('trashcan', 80, 100); g.destroy();
            }
        }

        const config = {
            type: Phaser.AUTO,
            scale: {
                mode: Phaser.Scale.RESIZE, // Important for full screen
                parent: 'game-container',
                width: '100%',
                height: '100%'
            },
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 1500 }, debug: false }
            },
            scene: MainScene
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>
